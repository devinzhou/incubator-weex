{"version":3,"file":"index.js","sources":["../../src/platforms/weex/entry-framework.js"],"sourcesContent":["// this will be preserved during build\r\nconst VueFactory = require('./factory')\r\n\r\nconst instances = {}\r\n\r\n/**\r\n * Prepare framework config.\r\n * Nothing need to do actually, just an interface provided to weex runtime.\r\n */\r\nexport function init () {}\r\n\r\n/**\r\n * Reset framework config and clear all registrations.\r\n */\r\nexport function reset () {\r\n  clear(instances)\r\n}\r\n\r\n/**\r\n * Delete all keys of an object.\r\n * @param {object} obj\r\n */\r\nfunction clear (obj) {\r\n  for (const key in obj) {\r\n    delete obj[key]\r\n  }\r\n}\r\n\r\n/**\r\n * Create an instance with id, code, config and external data.\r\n * @param {string} instanceId\r\n * @param {string} appCode\r\n * @param {object} config\r\n * @param {object} data\r\n * @param {object} env { info, config, services }\r\n */\r\nexport function createInstance (\r\n  instanceId,\r\n  appCode = '',\r\n  config = {},\r\n  data,\r\n  env = {}\r\n) {\r\n  const weex = env.weex\r\n  const document = weex.document\r\n  const instance = instances[instanceId] = {\r\n    instanceId, config, data,\r\n    document\r\n  }\r\n\r\n  const timerAPIs = getInstanceTimer(instanceId, weex.requireModule)\r\n\r\n  // Each instance has a independent `Vue` module instance\r\n  const Vue = instance.Vue = createVueModuleInstance(instanceId, weex)\r\n\r\n  // The function which create a closure the JS Bundle will run in.\r\n  // It will declare some instance variables like `Vue`, HTML5 Timer APIs etc.\r\n  const instanceVars = Object.assign({\r\n    Vue,\r\n    weex\r\n  }, timerAPIs, env.services)\r\n\r\n  appCode = `(function(global){ \\n${appCode}\\n })(Object.create(this))`\r\n\r\n  callFunction(instanceVars, appCode)\r\n\r\n  // Send `createFinish` signal to native.\r\n  document.taskCenter.send('dom', { action: 'createFinish' }, [])\r\n\r\n  return instance\r\n}\r\n\r\n/**\r\n * Destroy an instance with id. It will make sure all memory of\r\n * this instance released and no more leaks.\r\n * @param {string} instanceId\r\n */\r\nexport function destroyInstance (instanceId) {\r\n  const instance = instances[instanceId]\r\n  if (instance && instance.app instanceof instance.Vue) {\r\n    instance.document.destroy()\r\n    instance.app.$destroy()\r\n    delete instance.document\r\n    delete instance.app\r\n  }\r\n  delete instances[instanceId]\r\n}\r\n\r\n/**\r\n * Refresh an instance with id and new top-level component data.\r\n * It will use `Vue.set` on all keys of the new data. So it's better\r\n * define all possible meaningful keys when instance created.\r\n * @param {string} instanceId\r\n * @param {object} data\r\n */\r\nexport function refreshInstance (instanceId, data) {\r\n  const instance = instances[instanceId]\r\n  if (!instance || !(instance.app instanceof instance.Vue)) {\r\n    return new Error(`refreshInstance: instance ${instanceId} not found!`)\r\n  }\r\n  for (const key in data) {\r\n    instance.Vue.set(instance.app, key, data[key])\r\n  }\r\n  // Finally `refreshFinish` signal needed.\r\n  instance.document.taskCenter.send('dom', { action: 'refreshFinish' }, [])\r\n}\r\n\r\n/**\r\n * Get the JSON object of the root element.\r\n * @param {string} instanceId\r\n */\r\nexport function getRoot (instanceId) {\r\n  const instance = instances[instanceId]\r\n  if (!instance || !(instance.app instanceof instance.Vue)) {\r\n    return new Error(`getRoot: instance ${instanceId} not found!`)\r\n  }\r\n  return instance.app.$el.toJSON()\r\n}\r\n\r\nconst jsHandlers = {\r\n  fireEvent: (id, ...args) => {\r\n    return fireEvent(instances[id], ...args)\r\n  },\r\n  callback: (id, ...args) => {\r\n    return callback(instances[id], ...args)\r\n  }\r\n}\r\n\r\nfunction fireEvent (instance, nodeId, type, e, domChanges) {\r\n  const el = instance.document.getRef(nodeId)\r\n  if (el) {\r\n    return instance.document.fireEvent(el, type, e, domChanges)\r\n  }\r\n  return new Error(`invalid element reference \"${nodeId}\"`)\r\n}\r\n\r\nfunction callback (instance, callbackId, data, ifKeepAlive) {\r\n  const result = instance.document.taskCenter.callback(callbackId, data, ifKeepAlive)\r\n  instance.document.taskCenter.send('dom', { action: 'updateFinish' }, [])\r\n  return result\r\n}\r\n\r\n/**\r\n * Accept calls from native (event or callback).\r\n *\r\n * @param  {string} id\r\n * @param  {array} tasks list with `method` and `args`\r\n */\r\nexport function receiveTasks (id, tasks) {\r\n  const instance = instances[id]\r\n  if (instance && Array.isArray(tasks)) {\r\n    const results = []\r\n    tasks.forEach((task) => {\r\n      const handler = jsHandlers[task.method]\r\n      const args = [...task.args]\r\n      /* istanbul ignore else */\r\n      if (typeof handler === 'function') {\r\n        args.unshift(id)\r\n        results.push(handler(...args))\r\n      }\r\n    })\r\n    return results\r\n  }\r\n  return new Error(`invalid instance id \"${id}\" or tasks`)\r\n}\r\n\r\n/**\r\n * Create a fresh instance of Vue for each Weex instance.\r\n */\r\nfunction createVueModuleInstance (instanceId, weex) {\r\n  const exports = {}\r\n  VueFactory(exports, weex.document)\r\n  const Vue = exports.Vue\r\n\r\n  const instance = instances[instanceId]\r\n\r\n  // patch reserved tag detection to account for dynamically registered\r\n  // components\r\n  const weexRegex = /^weex:/i\r\n  const isReservedTag = Vue.config.isReservedTag || (() => false)\r\n  const isRuntimeComponent = Vue.config.isRuntimeComponent || (() => false)\r\n  Vue.config.isReservedTag = name => {\r\n    return (!isRuntimeComponent(name) && weex.supports(`@component/${name}`)) ||\r\n      isReservedTag(name) ||\r\n      weexRegex.test(name)\r\n  }\r\n  Vue.config.parsePlatformTagName = name => name.replace(weexRegex, '')\r\n\r\n  // expose weex-specific info\r\n  Vue.prototype.$instanceId = instanceId\r\n  Vue.prototype.$document = instance.document\r\n\r\n  // expose weex native module getter on subVue prototype so that\r\n  // vdom runtime modules can access native modules via vnode.context\r\n  Vue.prototype.$requireWeexModule = weex.requireModule\r\n\r\n  // Hack `Vue` behavior to handle instance information and data\r\n  // before root component created.\r\n  Vue.mixin({\r\n    beforeCreate () {\r\n      const options = this.$options\r\n      // root component (vm)\r\n      if (options.el) {\r\n        // set external data of instance\r\n        const dataOption = options.data\r\n        const internalData = (typeof dataOption === 'function' ? dataOption() : dataOption) || {}\r\n        options.data = Object.assign(internalData, instance.data)\r\n        // record instance by id\r\n        instance.app = this\r\n      }\r\n    }\r\n  })\r\n\r\n  /**\r\n   * @deprecated Just instance variable `weex.config`\r\n   * Get instance config.\r\n   * @return {object}\r\n   */\r\n  Vue.prototype.$getConfig = function () {\r\n    if (instance.app instanceof Vue) {\r\n      return instance.config\r\n    }\r\n  }\r\n\r\n  return Vue\r\n}\r\n\r\n/**\r\n * Generate HTML5 Timer APIs. An important point is that the callback\r\n * will be converted into callback id when sent to native. So the\r\n * framework can make sure no side effect of the callback happened after\r\n * an instance destroyed.\r\n * @param  {[type]} instanceId   [description]\r\n * @param  {[type]} moduleGetter [description]\r\n * @return {[type]}              [description]\r\n */\r\nfunction getInstanceTimer (instanceId, moduleGetter) {\r\n  const instance = instances[instanceId]\r\n  const timer = moduleGetter('timer')\r\n  const timerAPIs = {\r\n    setTimeout: (...args) => {\r\n      const handler = function () {\r\n        args[0](...args.slice(2))\r\n      }\r\n\r\n      timer.setTimeout(handler, args[1])\r\n      return instance.document.taskCenter.callbackManager.lastCallbackId.toString()\r\n    },\r\n    setInterval: (...args) => {\r\n      const handler = function () {\r\n        args[0](...args.slice(2))\r\n      }\r\n\r\n      timer.setInterval(handler, args[1])\r\n      return instance.document.taskCenter.callbackManager.lastCallbackId.toString()\r\n    },\r\n    clearTimeout: (n) => {\r\n      timer.clearTimeout(n)\r\n    },\r\n    clearInterval: (n) => {\r\n      timer.clearInterval(n)\r\n    }\r\n  }\r\n  return timerAPIs\r\n}\r\n\r\n/**\r\n * Call a new function body with some global objects.\r\n * @param  {object} globalObjects\r\n * @param  {string} code\r\n * @return {any}\r\n */\r\nfunction callFunction (globalObjects, body) {\r\n  const globalKeys = []\r\n  const globalValues = []\r\n  for (const key in globalObjects) {\r\n    globalKeys.push(key)\r\n    globalValues.push(globalObjects[key])\r\n  }\r\n  globalKeys.push(body)\r\n\r\n  const result = new Function(...globalKeys)\r\n  return result(...globalValues)\r\n}\r\n"],"names":["const"],"mappings":"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"}